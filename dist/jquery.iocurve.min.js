!function(A){"use strict";var G=Math.PI/2;Math.PI;function H(t){return t?t%G?Math.cos(t):0:1}function J(t,a,e,n,i){var o=(i-e)/(n-a);return o*t+(e-o*a)}A.fn.iocurve=function(a){return this.each(function(){var t={x:[0,255],y:[0,255],dx:1,y0:0,curvature:.3,height:"100%",className:"",css:{position:"relative",margin:"20px"},canvas:{css:{display:"block",boxShadow:"0 0 3px #000"},fillStyle:"#fff"},grid:{strokeStyle:"rgba(0, 0, 0, 0.2)"},anchor:{points:[[0,0],[255,255]],tagName:"a",className:"anchor",css:{position:"absolute",display:"block",width:18,height:18,borderRadius:"50%",border:"1px solid rgba(0, 0, 0, 0.5)",background:"#fff",boxSizing:"border-box",cursor:"move",transform:"translate(-50%, -50%)"}},bar:{visible:!0,fillStyle:{positive:"rgba(0, 100, 70, 0.2)",negative:"rgba(150, 30, 70, 0.2)"}},plot:{visible:!1,strokeStyle:"#f00"},histogram:{data:null,fillStyle:"#ddd"},controlPoint:{visible:!1,strokeStyle:"#00f"}};A.extend(!0,t,a),function(y){var l,f,u,M,a,e,x,b,i=A(this),w=A(document.createElement("div")),F=A(),n=document.createElement("canvas"),r=n.getContext("2d"),c=[],m=[],d=[],v=[],p=[],N=[],P=[],R=[],q=[];function o(t){var p,M,a=A(t.target);if(a.closest(this).length){if(a.hasClass(y.anchor.className)){if((M=F.index(t.target))<0)return;p=F.eq(M)}else{var e=w.offset(),n=t.pageX-e.left,i=t.pageY-e.top;if(F.each(function(t){return parseFloat(this.style.left)<n&&void(M=t+1)}),!(M&&M<F.length))return;var o=parseFloat(F[M-1].style.left),r=parseFloat(F[M].style.left);if((n=Math.min(Math.max(o,n),r))===o||n===r)return;i=Math.min(Math.max(i,0),x),p=X(n,i).insertBefore(F.eq(M)),F=w.find("."+y.anchor.className),S(p,"new"),C()}var m={x:t.pageX,y:t.pageY,left:parseFloat(p.css("left")),top:parseFloat(p.css("top"))};A(document).one("mouseup",g),A(document).on("mousemove",s),t.preventDefault()}function g(){A(document).off("mousemove",s)}function s(t){var a,e,n,i,o=t.pageX-m.x,r=t.pageY-m.y,s=Math.min(Math.max(m.left+o,0),x),h=Math.min(Math.max(m.top+r,0),b);if(0===M)s=0;else if(M===F.length-1)s=x;else{var l=F[M-1],f=F[M+1],c=parseFloat(l.style.left),u=parseFloat(f.style.left),d=parseFloat(l.style.top),v=parseFloat(f.style.top),s=Math.min(Math.max(s,c),u);if(n=Math.abs(s-c),i=Math.abs(h-d),n+i<6||(a=Math.abs(s-u),e=Math.abs(h-v),a+e<6))return g(),S(p,"remove"),p.remove(),F=w.find("."+y.anchor.className),void C()}p.css("left",s),p.css("top",h),p.data("p",Y(s,h)),S(p,"move"),C()}}function S(t,a){var e=t.data("p"),n={target:t[0],kind:a,x:e[0],y:e[1]};i.trigger("anchor",[n])}function s(t,a){return a.call(this,d),!1}function h(t,a){return A.extend(!0,y,a),k(),T(),function(){for(var t=F.length;t--;){var a=F.eq(t),e=parseFloat(a.css("left")),n=parseFloat(a.css("top"));a.data("p",Y(e,n))}}(),C(),!1}function g(){return T(),F.each(function(){var t=A(this).data("p");A(this).css(I(t))}),C(),!1}function k(){l=y.x[1]-y.x[0],f=y.y[1]-y.y[0],u=Math.floor(l/y.dx)+1,M=100*y.dx<l?y.dx/l:.01,A.each(y.canvas.css,function(t,a){n.style[t]=a}),w.addClass(y.className).css(y.css)}function T(){n.width=0,x=w.width(),b=/%/.test(y.height)?x*parseFloat(y.height)/100:y.height,n.width=x*devicePixelRatio,n.height=b*devicePixelRatio,n.style.width=x+"px",n.style.height=b+"px",a=n.width/l,e=n.height/f,setTimeout(function(){w.width()<x-1&&g()},0)}function C(){!function(){var x=[],b=[],w=[],S=[],d=[],v=[],k=F.length-1,t=F.length<3||y.curvature<=0;c.length=m.length=0,N.length=P.length=0;for(var p=R.length=q.length=0;p<F.length;p++){var a,e,n,i=F.eq(p).data("p"),o=i[0],r=i[1],s=(o-y.x[0])/l,h=(r-y.y[0])/f;c[p]=o,m[p]=r,x[p]=s,b[p]=h,p&&(a=s-x[p-1],e=h-b[p-1],n=Math.sqrt(Math.pow(a,2)+Math.pow(e,2)),w[p-1]=n*y.curvature)}if(t)return z(x,b);for(p=1;p<k;p++)S[p]=function(t,a,e,n,i,o,r,s,h){if(r=Math.pow(e,2)+Math.pow(n,2),s=Math.pow(i,2)+Math.pow(o,2),r<s)return(h=r/s)*Math.atan2(a,t)+(1-h)*Math.atan2(n,e);if(s<r)return(h=s/r)*Math.atan2(a,t)+(1-h)*Math.atan2(o,i);return Math.atan2(a,t)}(x[p+1]-x[p-1],b[p+1]-b[p-1],x[p]-x[p-1],b[p]-b[p-1],x[p+1]-x[p],b[p+1]-b[p]),function(t,a,e,n,i,o){var r=a-H(o)*n,s=e-Math.sin(o)*n,h=a+H(o)*i,l=e+Math.sin(o)*i;(s<0||1<s)&&(r=Math.min(Math.max(r,0),1),s=Math.min(Math.max(s,0),1),o=S[t]=Math.atan2(e-s,a-r),h=a+H(o)*i,l=e+Math.sin(o)*i);(l<0||1<l)&&(h=Math.min(Math.max(h,0),1),l=Math.min(Math.max(l,0),1),o=S[t]=Math.atan2(l-e,h-a),r=a-H(o)*n,s=e-Math.sin(o)*n);N[t]=r,P[t]=s,R[t]=h,q[t]=l}(p,x[p],b[p],w[p-1],w[p],S[p]);(function(){var t,a,e,n,i,o,r,s,h,l=x[0],f=b[0],c=x[1],u=b[1],d=S[1];h=f===u?(s=(l+c)/2,s-=(o=c-H(d))-s,u-Math.sin(d)):(a=(f+u)/2-(l+c)/2*(t=(l-c)/(u-f)),e=2*Math.atan(t),n=Math.sin(e),s=(i=H(e))*(o=c-H(d))+n*(r=u-Math.sin(d)-a),n*o-i*r+a);var v=s-l,p=h-f,M=Math.atan2(p,v);(M<-G||G<M)&&(M=f<u?G:-G),S[0]=M;var m=w[0],g=l+H(M)*m,y=f+Math.sin(M)*m,g=Math.min(Math.max(g,0),1),y=Math.min(Math.max(y,0),1);R[0]=g,q[0]=y})(),function(){var t,a,e,n,i,o,r,s,h,l=x[k-1],f=b[k-1],c=S[k-1],u=x[k],d=b[k];h=f===d?(s=(l+u)/2,s+=s-(o=l+H(c)),f+Math.sin(c)):(a=(f+d)/2-(l+u)/2*(t=(l-u)/(d-f)),e=2*Math.atan(t),n=Math.sin(e),s=(i=H(e))*(o=l+H(c))+n*(r=f+Math.sin(c)-a),n*o-i*r+a);var v=u-s,p=d-h,M=Math.atan2(p,v);(M<-G||G<M)&&(M=f<d?G:-G),S[k]=M;var m=w[k-1],g=u-H(M)*m,y=d-Math.sin(M)*m,g=Math.min(Math.max(g,0),1),y=Math.min(Math.max(y,0),1);N[k]=g,P[k]=y}(),d.push(x[0]),v.push(b[0]);for(p=0;p<k;p++)!function(a,e,n,i,o,r,s,h){s<o&&function(){var t=(a+n)/2;if(t<=s)return r=J(s,a,e,o,r)||r,o=s,R[p]=o,q[p]=r;if(o<=t)return h=J(o,n,i,s,h)||h,s=o,N[p+1]=s,P[p+1]=h;r=J(t,a,e,o,r)||r,h=J(t,n,i,s,h)||h,o=s=t,R[p]=o,q[p]=r,N[p+1]=s,P[p+1]=h}();for(var t=Math.floor((n-a)/M),l=1;l<t;l++){var f=function(t,a,e,n,i,o,r,s,h){var l=1-h,f=h*h,c=l*l,u=f*h,d=c*l,v=3*c*h,p=3*l*f;return[d*t+v*i+p*r+u*e,d*a+v*o+p*s+u*n]}(a,e,n,i,o,r,s,h,l/t),c=Math.min(Math.max(f[0],0),1),u=Math.min(Math.max(f[1],0),1);d.push(c),v.push(u)}d.push(n),v.push(i)}(x[p],b[p],x[p+1],b[p+1],R[p],q[p],N[p+1],P[p+1]);z(d,v)}(),r.clearRect(0,0,n.width,n.height),r.fillStyle=y.canvas.fillStyle,r.fillRect(0,0,n.width,n.height),function(){if(!y.histogram.data)return;r.fillStyle=y.histogram.fillStyle;for(var t=r.canvas.width*y.dx/l,a=t/2,e=u;e--;){var n=v[e],i=(1-y.histogram.data[e])*r.canvas.height;r.fillRect(n-a,i,t,r.canvas.height-i)}}(),r.strokeStyle=y.grid.strokeStyle,E(n.width/2+.5,0,n.width/2+.5,n.height),E(0,n.height/2+.5,n.width,n.height/2+.5),y.bar.visible&&function(){for(var t=r.canvas.width*y.dx/l,a=t/2,e=Q(y.y0),n=u;n--;){var i=v[n],o=p[n];d[n]<0?(r.fillStyle=y.bar.fillStyle.negative,r.fillRect(i-a,e,t,o-e)):(r.fillStyle=y.bar.fillStyle.positive,r.fillRect(i-a,o,t,e-o))}}(),y.plot.visible&&function(){r.fillStyle=y.plot.strokeStyle;for(var t=u;t--;)r.fillRect(v[t]-2,p[t]-2,4,4)}(),y.controlPoint.visible&&N.length&&function(){r.strokeStyle=y.controlPoint.strokeStyle;for(var t=c.length-1;t--;)E(D(c[t]),Q(m[t]),D(j(R[t])),Q(B(q[t]))),E(D(c[t+1]),Q(m[t+1]),D(j(N[t+1])),Q(B(P[t+1])))}()}function z(t,a){var e,n,i=t.length-2,o=1/(u-1);c();for(var r=u;r--;){var s=r*o;if(s<t[i]){for(;s<t[i];)i--;c()}var h=e*s+n,l=j(s),f=B(h);v[r]=D(l),p[r]=Q(f),d[r]=f}function c(){e=(a[i+1]-a[i])/(t[i+1]-t[i]),n=a[i]-e*t[i]}}function E(t,a,e,n){r.beginPath(),r.moveTo(t,a),r.lineTo(e,n),r.stroke(),r.closePath()}function X(t,a){var e=A(document.createElement(y.anchor.tagName));return e.addClass(y.anchor.className),e.css(y.anchor.css),e.css("left",t),e.css("top",a),e.data("p",Y(t,a)),e}function Y(t,a){return[y.x[0]+t*l/x,y.y[0]+(b-a)*f/b]}function I(t){return{left:(t[0]-y.x[0])*x/l,top:(f-(t[1]-y.y[0]))*b/f}}function j(t){return t*l+y.x[0]}function B(t){return t*f+y.y[0]}function D(t){return(t-y.x[0])*a}function Q(t){return(y.y[1]-t)*e}w.append(n).appendTo(i),i.on("mousedown",o),i.on("data",s),i.on("option",h),i.on("resized",g),i.on("destroy",function t(){i.off("mousedown",o),i.off("data",s),i.off("option",h),i.off("resized",g),i.off("destroy",t),w.remove()}),k(),T(),function(){for(var t=y.anchor.points,a=0;a<t.length;a++){var e=I(t[a]),n=X(e.left,e.top);F=F.add(n)}F.appendTo(w)}(),C()}.call(this,t)}),this}}(jQuery);